<!DOCTYPE html>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" lang="en-gb" xml:lang="en-gb" data-mc-search-type="Stem" data-mc-help-system-file-name="Model Developer Guide.xml" data-mc-path-to-help-system="../../" data-mc-target-type="WebHelp2" data-mc-runtime-file-type="Topic" data-mc-preload-images="false" data-mc-in-preview-mode="false" data-mc-medium="non-print" data-mc-toc-path="Custom Modelling in gPROMS|Stochastic Simulation in gPROMS">
    <!-- saved from url=(0016)http://localhost -->
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>Plotting results of multiple stochastic simulations</title>
        <link href="../../Skins/Default/Stylesheets/Slideshow.css" rel="stylesheet" data-mc-generated="True" />
        <link href="../../Skins/Default/Stylesheets/TextEffects.css" rel="stylesheet" data-mc-generated="True" />
        <link href="../../Skins/Default/Stylesheets/Topic.css" rel="stylesheet" data-mc-generated="True" />
        <link href="../../Skins/Default/Stylesheets/Components/Styles.css" rel="stylesheet" data-mc-generated="True" />
        <link href="../Resources/Stylesheets/GeneralStyles.css" rel="stylesheet" />
        <script src="../../Resources/Scripts/custom.modernizr.js">
        </script>
        <script src="../../Resources/Scripts/jquery.min.js">
        </script>
        <script src="../../Resources/Scripts/require.min.js">
        </script>
        <script src="../../Resources/Scripts/require.config.js">
        </script>
        <script src="../../Resources/Scripts/foundation.min.js">
        </script>
        <script src="../../Resources/Scripts/plugins.min.js">
        </script>
        <script src="../../Resources/Scripts/MadCapAll.js">
        </script>
    </head>
    <body>
        <p class="MCWebHelpFramesetLink MCWebHelpFramesetLinkTop"><a href="../../Model Developer Guide.htm#Topics/x7030.html">Open topic with navigation</a>
        </p>
        <div>
            <div class="MCBreadcrumbsBox_0"><span class="MCBreadcrumbsPrefix">You are here: </span><a class="MCBreadcrumbsLink" href="Custom Modelling.htm">Custom Modelling in gPROMS</a><span class="MCBreadcrumbsDivider"> &gt; </span><a class="MCBreadcrumbsLink" href="c6927.html">Stochastic Simulation in gPROMS</a><span class="MCBreadcrumbsDivider"> &gt; </span><span class="MCBreadcrumbs">Plotting results of multiple stochastic simulations</span>
            </div>
        </div>
        <div class="sect1">
            <h1 class="sect1"><a name="AEN7030"></a>Plotting results of multiple stochastic simulations</h1>
            <p>In order to examine how the distributions of key output Variables are influenced by the distributions of the input Variables, we will
 describe how you can <a href="#">combine multiple simulations</a> in a single process and then use the results to evaluate
 metrics (such as the mean, variance, etc.) of the output Variables. Thereafter, we will outline a method that allows you to <a href="#">plot the probability density functions</a> of the output Variables.</p>
            <div class="sect2">
                <h2 class="sect2"><a name="AEN7035"></a>Combining multiple simulations</h2>
                <p>Given a model with some uncertain inputs, a series of simulations can be combined into a single process by introducing a new higher-level
 Model. The original model is included in the new one as an array of Units, as shown below.</p><pre class="programlisting"># MODEL ModelUncertain

 ...

 VARIABLE
 Input AS InputVarType # uncertain input variable
 Output AS OutputVarType # important output variable

 ...



# MODEL Combined

 PARAMETER
 NoScenarios AS INTEGER
 InputMean AS REAL
 InputStdDev AS REAL

 UNIT
 Scenarios AS ARRAY(NoScenarios) OF ModelUncertain</pre>
                <p>The input Variables for each scenario of ModelUncertain then need to be specified as
 follows.</p><pre class="programlisting"># PROCESS StochSim

 UNIT
 StSim AS Combined

 ...

 ASSIGN
 WITHIN StSim DO
 FOR i := 1 TO NoScenarios DO
 Scenarios(i).Input := NORMAL(InputMean,InputStdDev) ;
 END
 END

 ...</pre>
                <p>Note that each input Variable is Assigned a different value from the same distribution. This could also have been done with Parameters,
 but <a href="x3199.html">parameter propagation</a> cannot be used in this way: this would result in all Parameters being set the
 same value, because the parameter in the higher-level model will be assigned randomly and then that particular value will be propagated to the
 scenarios. Of course, any inputs that are common to the system (such as design constants or precisely known operating Parameters) can be
 included in the higher-level model along with equations linking them to the scenarios. This reduces the complexity of the Schedule
 section.</p>
            </div>
            <div class="sect2">
                <h2 class="sect2"><a name="AEN7043"></a>Plotting probability density functions</h2>
                <p>Now all of the scenarios are together in one Process, but it is not easy to plot them together in one graph. Rather than having to select
 each Variable from each scenario instance, it would be much easier to be able to select the whole distribution. This can easily be done as
 follows.</p><pre class="programlisting"># MODEL Combined

 PARAMETER
 NoScenarios AS INTEGER
 InputMean AS REAL
 InputStdDev AS REAL

 UNIT
 Scenarios AS ARRAY(NoScenarios) OF ModelUncertain

 VARIABLE
 Input AS ARRAY(NoScenarios) OF InputVarType
 Output AS ARRAY(NoScenarios) OF OutputVarType

 OPmean AS NoType # mean of Output
 OPvariance AS NoType # variance of Output

 EQUATION
 FOR i := 1 TO NoScenarios DO
 Input(i) = Scenarios(i).Input ;
 Output(i) = Scenarios(i).Output ;
 END

 OPmean = SIGMA(Output)/NoScenarios ;
 OPvariance = SIGMA( (Output - OPmean)^2 )/NoScenarios ;</pre>
                <p>Now, all of the scenarios can be plotted on a single graph by selecting a single Variable in gRMS. Notice also that the mean and variance
 of the output can easily be calculated.</p>
                <p>Finally, it is often useful to be able to plot the probability density function (pdf) of the output. In general, for each Variable this
 requires two new Variables a distribution domain and three Parameters. However, if two Variables are in the same interval they can share the
 same distribution domain and Parameters. This is shown below.</p><pre class="programlisting"># MODEL Combined

 PARAMETER
 NoScenarios AS INTEGER
 InputMean AS REAL
 InputStdDev AS REAL

 NoInt_OP AS INTEGER DEFAULT 20 # number of intervals for distribution
 Upper_OP AS REAL DEFAULT 3 # upper bound on distribution
 Lower_OP AS REAL DEFAULT 1 # lower bound on distribution

 DISTRIBUTION_DOMAIN
 Dist_OP AS (Lower_OP:Upper_OP) # distribution over which
 # Output will be plotted
 UNIT
 Scenarios AS ARRAY(NoScenarios) OF ModelUncertain

 VARIABLE
 Input AS ARRAY(NoScenarios) OF InputVarType
 Output AS ARRAY(NoScenarios) OF OutputVarType

 OPmean AS NoType # mean of Output
 OPvariance AS NoType # variance of Output

# temp variable to count occurrences of Output in a particular interval:
 OPacc AS DISTRIBUTION(Dist_OP,NoScenarios) OF NoType

# pdf function for Output:
 OP_pdf AS DISTRIBUTION(Dist_OP) OF NoType

 EQUATION
 FOR i := 1 TO NoScenarios DO
 Input(i) = Scenarios(i).Input ;
 Output(i) = Scenarios(i).Output ;
 END

 OPmean = SIGMA(Output)/NoScenarios ;
 OPvariance = SIGMA( (Output - OPmean)^2 )/NoScenarios ;

 FOR i := Lower_OP TO Upper_OP DO
 FOR j := 1 TO NoScenarios DO
 IF i - (Upper_OP-Lower_OP)/NoInt_OP/2 &lt;= Output(j) AND 
 Output(j) &lt; i + (Upper_OP-Lower_OP)/NoInt_OP/2 THEN
 OPacc(i,j) = 1 ;
 ELSE
 OPacc(i,j) = 0 ;
 END
 END
 OP_pdf(i) = SIGMA(OPacc(i,))/NoScenarios ;
 END</pre>
                <p>The three new Parameters introduced are NoInt_OP, Lower_OP and
 Upper_OP. These Parameters define the distribution over which the output Variable will be
 plotted. NoInt_OP is the number of intervals used for the distribution Dist_OP. This will
 obviously be used to set Dist_OP:</p><pre class="programlisting"># PROCESS StSim

 ...

 SET
 ...
 Dist_OP := [BFDM, 1, NoInt_OP] ;</pre>
                <p>The first order, backward finite difference method is all that is required because the distribution domain is essentially behaving as an
 array. The Parameters Lower_OP and Upper_OP are simply the lower and upper bounds on the
 domain Dist_OP. The Variable being plotted, Output in this case, must lie in the interval
 [lower, upper] for each scenario; otherwise, the pdf will become distorted. If the lower and upper bounds are set so that a number of Variables
 lie in this interval, then all of these Variables can be plotted using the same distribution. The number of intervals should be set
 appropriately so that the distribution is not too coarse. Finally, the two Variables introduced are OPacc and
 OP_pdf. Each Variable being plotted will need its own pair of Variables. OPacc(i,j) is set to
 1 if the value of Output(j) (the value in scenario j) lies in interval i of the distribution domain.
 OP_pdf(i) therefore represents the number of scenarios in which Output has a value in interval
 i. This is divided by the number of scenarios to normalise the pdf. Plotting the pdf of a state Variable can slow down the simulation
 significantly (due to the many discontinuities, and therefore re-initialisations, encountered as the values of the Variables switch between
 intervals). This can be remedied by introducing one further Variable, as illustrated below for the example already considered:</p><pre class="programlisting"># MODEL Combined

 ...

 VARIABLE
 ...

# temporary Output variable = 0 until end of simulation, then = Output
 OutputEnd AS ARRAY(NoScenarios) OF OutputVarType

 ...

 EQUATION
 FOR i := 1 TO NoScenarios DO
 Input(i) = Scenarios(i).Input ;
 Output(i) = Scenarios(i).Output ;
 END

 ...

 FOR i := Lower_OP TO Upper_OP DO
 FOR j := 1 TO NoScenarios DO
 IF i - (Upper_OP-Lower_OP)/NoInt_OP/2 &lt;= OutputEnd(j) AND 
 OutputEnd(j) &lt; i + (Upper_OP-Lower_OP)/NoInt_OP/2 THEN
 OPacc(i,j) = 1 ;
 ELSE
 OPacc(i,j) = 0 ;
 END
 END
 OP_pdf(i) = SIGMA(OPacc(i,))/NoScenarios ;
 END



# PROCESS StochSim
 ...

 MONITOR
 StSim.Output(*) ;
 StSim.Input(*) ;
 StSim.OPmean ;
 StSim.OPvariance ;
 StSim.OP_pdf ;

 ...

 ASSIGN
 WITHIN StSim DO
 OutputEnd := 0 ;
 ...
 END

 ...

 SCHEDULE
 SEQUENCE
 ...
 RESET
 StSim.OutputEnd := OLD(StSim.Output) ;
 END
 END</pre>
                <p>So, OutputEnd is 0 throughout the simulation and the If conditions are only evaluated at initialisation. Only at
 the end of the simulation is OutputEnd changed, at which point all of the If statements are re-evaluated and
 OP_pdf recalculated. Finally, note that the output has been restricted to only those Variables of importance by using
 the Monitor section. This reduces the amount of data sent to the output channel (e.g. gRMS). Although this is not necessary, it recommended for
 moderate to large problems (even small problems output large quantities of data when the number of scenarios is large).</p>
            </div>
        </div>
        <div>
            <p class="Footer">&#160;</p>
            <p class="Footer">&#160;</p>
            <hr width="100%" size="0" align="center" />
            <p class="Footer">Commercial in confidence</p>
            <p class="Footer">© 2016 Process Systems Enterprise Limited</p>
        </div>
    </body>
</html>